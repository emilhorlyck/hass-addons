worker_processes 1;
error_log /dev/stderr info;
pid /run/nginx.pid;

# Load lua module (Debian path)
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    access_log /dev/stdout;

    sendfile on;
    keepalive_timeout 65;

    # Lua shared dict for caching
    lua_shared_dict ingress_cache 1m;

    # Upstream to actual-server
    upstream actual {
        server 127.0.0.1:5007;
    }

    server {
        listen 5006;

        # Only allow connections from Home Assistant ingress
        allow 172.30.32.2;
        # Also allow direct access for non-ingress usage
        allow 172.30.0.0/16;
        allow 192.168.0.0/16;
        allow 10.0.0.0/8;
        allow 127.0.0.1;
        deny all;

        location / {
            proxy_pass http://actual;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Buffer settings for body_filter to work
            proxy_buffering on;
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;

            # Use lua to rewrite responses for ingress
            header_filter_by_lua_block {
                -- Remove content-length as we may modify the body
                local ingress_path = ngx.var.http_x_ingress_path
                if ingress_path and ingress_path ~= "" then
                    ngx.header.content_length = nil
                end
            }

            body_filter_by_lua_block {
                local ingress_path = ngx.var.http_x_ingress_path or ""

                -- Only process if we have ingress path
                if ingress_path == "" then
                    return
                end

                -- Check content type
                local content_type = ngx.header["Content-Type"] or ""
                local is_html = content_type:find("text/html")
                local is_js = content_type:find("javascript")
                local is_css = content_type:find("text/css")
                local is_json = content_type:find("application/json")
                local is_manifest = content_type:find("application/manifest")

                if not (is_html or is_js or is_css or is_json or is_manifest) then
                    return
                end

                local chunk = ngx.arg[1]
                if chunk and chunk ~= "" then
                    if is_html then
                        -- Inject base tag and server URL script into HTML head
                        local base_inject = '<base href="' .. ingress_path .. '/">' ..
                            '<script>window.__ACTUAL_SERVER_URL__="' .. ingress_path .. '";</script>'
                        chunk = chunk:gsub('(<head[^>]*>)', '%1' .. base_inject)

                        -- Rewrite absolute paths in HTML attributes
                        chunk = chunk:gsub('(src=")/', '%1' .. ingress_path .. '/')
                        chunk = chunk:gsub("(src=')/", "%1" .. ingress_path .. "/")
                        chunk = chunk:gsub('(href=")/', '%1' .. ingress_path .. '/')
                        chunk = chunk:gsub("(href=')/", "%1" .. ingress_path .. "/")
                        chunk = chunk:gsub('(action=")/', '%1' .. ingress_path .. '/')
                        chunk = chunk:gsub("(action=')/", "%1" .. ingress_path .. "/")
                    end

                    if is_css then
                        -- Rewrite url() references in CSS
                        chunk = chunk:gsub('url%("/', 'url("' .. ingress_path .. '/')
                        chunk = chunk:gsub("url%('/", "url('" .. ingress_path .. "/")
                        chunk = chunk:gsub("url%(/", "url(" .. ingress_path .. "/")
                    end

                    if is_js then
                        -- Rewrite JavaScript fetch/API calls
                        chunk = chunk:gsub('fetch%("/', 'fetch("' .. ingress_path .. '/')
                        chunk = chunk:gsub("fetch%('/", "fetch('" .. ingress_path .. "/")

                        -- Rewrite common patterns for API endpoints
                        chunk = chunk:gsub('"/api/', '"' .. ingress_path .. '/api/')
                        chunk = chunk:gsub("'/api/", "'" .. ingress_path .. "/api/")

                        -- Rewrite patterns like url: "/..." or path: "/..."
                        chunk = chunk:gsub('(url:%s*")/', '%1' .. ingress_path .. '/')
                        chunk = chunk:gsub("(url:%s*')/", "%1" .. ingress_path .. "/")
                        chunk = chunk:gsub('(path:%s*")/', '%1' .. ingress_path .. '/')
                        chunk = chunk:gsub("(path:%s*')/", "%1" .. ingress_path .. "/")

                        -- Rewrite service worker and import paths
                        chunk = chunk:gsub('"/sw%.js', '"' .. ingress_path .. '/sw.js')
                        chunk = chunk:gsub("'/sw%.js", "'" .. ingress_path .. "/sw.js")
                        chunk = chunk:gsub('"/static/', '"' .. ingress_path .. '/static/')
                        chunk = chunk:gsub("'/static/", "'" .. ingress_path .. "/static/")
                    end

                    if is_json or is_manifest then
                        -- Rewrite paths in JSON/manifest files
                        chunk = chunk:gsub('"/static/', '"' .. ingress_path .. '/static/')
                        chunk = chunk:gsub('"/icons/', '"' .. ingress_path .. '/icons/')
                        chunk = chunk:gsub('"/', '"' .. ingress_path .. '/')
                    end

                    ngx.arg[1] = chunk
                end
            }
        }
    }
}
