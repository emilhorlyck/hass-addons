worker_processes 1;
error_log /dev/stderr info;
pid /run/nginx.pid;

# Load lua module (Debian path)
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    access_log /dev/stdout;

    sendfile on;
    keepalive_timeout 65;

    # Upstream to actual-server
    upstream actual {
        server 127.0.0.1:5007;
    }

    server {
        listen 5006;

        # Only allow connections from Home Assistant ingress
        allow 172.30.32.2;
        # Also allow direct access for non-ingress usage
        allow 172.30.0.0/16;
        allow 192.168.0.0/16;
        allow 10.0.0.0/8;
        allow 127.0.0.1;
        deny all;

        location / {
            proxy_pass http://actual;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Buffer settings for body_filter to work
            proxy_buffering on;
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;

            # Use lua to rewrite responses for ingress
            header_filter_by_lua_block {
                -- Remove content-length as we may modify the body
                local ingress_path = ngx.var.http_x_ingress_path
                if ingress_path and ingress_path ~= "" then
                    ngx.header.content_length = nil
                end
            }

            body_filter_by_lua_block {
                local ingress_path = ngx.var.http_x_ingress_path or ""

                -- Only process if we have ingress path
                if ingress_path == "" then
                    return
                end

                -- Only process HTML and JavaScript content
                local content_type = ngx.header["Content-Type"] or ""
                if not (content_type:find("text/html") or content_type:find("javascript")) then
                    return
                end

                local chunk = ngx.arg[1]
                if chunk and chunk ~= "" then
                    -- Escape special pattern characters in ingress_path
                    local escaped_path = ingress_path:gsub("([%-%.%+%[%]%(%)%$%^%%%?%*])", "%%%1")

                    -- Rewrite absolute paths to include ingress path
                    -- Handle src="/...", href="/...", action="/..."
                    chunk = chunk:gsub('(src=")/', '%1' .. ingress_path .. '/')
                    chunk = chunk:gsub("(src=')/", "%1" .. ingress_path .. "/")
                    chunk = chunk:gsub('(href=")/', '%1' .. ingress_path .. '/')
                    chunk = chunk:gsub("(href=')/", "%1" .. ingress_path .. "/")
                    chunk = chunk:gsub('(action=")/', '%1' .. ingress_path .. '/')
                    chunk = chunk:gsub("(action=')/", "%1" .. ingress_path .. "/")

                    -- Handle JavaScript fetch calls and API paths
                    chunk = chunk:gsub('fetch%("/', 'fetch("' .. ingress_path .. '/')
                    chunk = chunk:gsub("fetch%('/", "fetch('" .. ingress_path .. "/")

                    ngx.arg[1] = chunk
                end
            }
        }
    }
}
